import 'package:flutter/material.dart';

import '/flutter_flow/flutter_flow_util.dart';
import '../../services/health_service.dart';
import '../../services/user_service.dart';
import 'my_profile_widget.dart';

class MyProfileModel extends FlutterFlowModel<MyProfileWidget>
    with ChangeNotifier {
  final UserService _userService = UserService();

  String name = '';
  String age = '';
  String phoneNumber = '';
  String location = '';
  String email = '';
  String height = '';
  String weight = '';
  String activityLevel = '';
  String userId = '';
  List<String> allergies = []; // ‚úÖ D·ªã ·ª©ng
  List<String> diseases = []; // ‚úÖ B·ªánh n·ªÅn
  String goalType = ''; // ‚úÖ M·ª•c ti√™u s·ª©c kh·ªèe
  String targetWeight = ''; // ‚úÖ C√¢n n·∫∑ng m·ª•c ti√™u

  @override
  void initState(BuildContext context) {
    fetchUserProfile();
    fetchHealthProfile();
  }

  Future<void> fetchUserProfile() async {
    try {
      print("üîÑ ƒêang g·ªçi API c·∫≠p nh·∫≠t profile...");
      final response = await _userService.whoAmI();
      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        name = data['name'] ?? "Ch∆∞a c·∫≠p nh·∫≠t";
        age = data['age']?.toString() ?? "0";
        phoneNumber = data['phoneNumber'] ?? "Ch∆∞a c·∫≠p nh·∫≠t";
        location = data['address'] ?? "Ch∆∞a c·∫≠p nh·∫≠t";
        email = data["email"] ?? "Ch∆∞a c·∫≠p nh·∫≠t";
        userId = data['id']?.toString() ?? "";
        notifyListeners();
      } else {
        debugPrint('‚ùå Failed to fetch user profile');
      }
    } catch (e) {
      debugPrint("‚ùå L·ªói khi l·∫•y th√¥ng tin ng∆∞·ªùi d√πng: $e");
    }
  }

  Future<void> fetchHealthProfile() async {
    try {
      print("üîÑ ƒêang l·∫•y th√¥ng tin s·ª©c kh·ªèe t·ª´ API...");
      final healthData = await HealthService.fetchHealthData();

      if (healthData["healthData"] != null) {
        final data = healthData["healthData"];

        height = data["height"]?.toString() ?? "N/A";
        weight = data["weight"]?.toString() ?? "N/A";
        activityLevel = data["activityLevel"] ?? "N/A";

        // L·∫•y danh s√°ch d·ªã ·ª©ng
        allergies = data["allergies"] != null
            ? (data["allergies"] as List)
                .map((allergy) => allergy["allergyName"].toString())
                .toList()
            : [];

        // L·∫•y danh s√°ch b·ªánh n·ªÅn
        diseases = data["diseases"] != null
            ? (data["diseases"] as List)
                .map((diseases) => diseases["diseaseName"].toString())
                .toList()
            : [];

        // N·∫øu c√≥ d·ªØ li·ªáu m·ª•c ti√™u c√° nh√¢n
        if (healthData["personalGoal"] != null) {
          final personalGoal = healthData["personalGoal"];
          goalType = personalGoal["goalType"] ?? "Ch∆∞a ƒë·∫∑t m·ª•c ti√™u";
          targetWeight = personalGoal["targetWeight"]?.toString() ?? "N/A";
        }

        notifyListeners();
      } else {
        print("‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu s·ª©c kh·ªèe: ${healthData["errorMessage"]}");
      }
    } catch (e) {
      print("‚ùå L·ªói khi fetch d·ªØ li·ªáu s·ª©c kh·ªèe: $e");
    }
  }

  @override
  void dispose() {}
}
